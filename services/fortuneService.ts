
import { FortunePoem } from "../types";

/**
 * 專家級六十甲子靈籤大師知識庫
 * 內嵌深度命理邏輯，字數豐沛且解析精準。
 */
const MASTER_DB: Record<number, { 
  title: string; 
  poem: string[]; 
  story: string; 
  level: string;
  analysis: string;
}> = {
  1: { 
    title: "甲子 ‧ 包公請雷祖", level: "大吉", 
    story: "包公審理烏盆冤案，至誠感通上蒼，雷祖下凡顯聖，霹靂一聲使真相大白，冤屈得雪。", 
    poem: ["日出便見風雲散", "光明清淨照世間", "一向前途通大道", "萬事清吉保平安"],
    analysis: "【大師深度開示】：\n弟子請聽，抽得此甲子首籤，乃是「枯木逢春、雲開見日」之極致吉兆。包公請雷祖代表的是一股天地間的正氣與轉機。若您先前感到受屈、壓抑或前途茫茫，此刻便是命運翻轉的起點。\n\n【詩意逐句解析】：\n1. 「日出便見風雲散」：太陽升起，過往遮蔽您視線的風雲霧霾將在瞬間煙消雲散。\n2. 「光明清淨照世間」：您的處境將會變得透明清晰，不再有小人作祟或暗晦不明之事。\n3. 「一向前途通大道」：這不是小小的改變，而是一條康莊大道正為您鋪展開來。\n4. 「萬事清吉保平安」：最終能得全方位圓滿，身心安適。\n\n【諸事運勢詳解】：\n- 事業：若求轉職，此為天時地利之際；若在任，則有升遷之喜，過去的努力將被看見。\n- 感情：單身者將有正緣出現，如旭日東昇般暖心；有伴者誤會冰釋，感情升溫。\n- 財運：財源廣進，且多為正財。以往的投資或欠款有收回之象。\n- 健康：若有宿疾，將遇良醫。此籤主火，需注意作息規律。\n- 訴訟：正義彰顯，冤情得雪，大吉。\n\n【慈愛勉勵】：\n此籤雖大吉，但需效法包公之「正」。待人處事需公道無私，多行善事以回饋上蒼。近期可往北方寺廟參拜，增添靈氣。"
  },
  2: { 
    title: "乙丑 ‧ 薛丁山著迷", level: "下下", 
    story: "薛丁山因一時貪戀美色與迷信，誤入陷阱，險些毀掉軍機大業，終受重重磨難方得醒悟。", 
    poem: ["於今此景正當時", "看看欲晚日遲遲", "勸君把定心莫虛", "天意自有好時節"],
    analysis: "【大師深度開示】：\n弟子莫急，此籤乃是「困龍受縛、時運未濟」之象。薛丁山著迷告誡我們，目前您所處的環境充滿了誘惑與幻象，極容易因一時的貪念或執著而做出錯誤判斷。\n\n【詩意逐句解析】：\n1. 「於今此景正當時」：現在的情況正如日落西山，正是危急與停滯的交界點。\n2. 「看看欲晚日遲遲」：事情的發展比預期的慢，且有越來越艱難的趨勢。\n3. 「勸君把定心莫虛」：最重要的一句！心若不動，風又奈何？千萬不可心虛浮躁。\n4. 「天意自有好時節」：天時未到，強求無益。現在是修煉內心的時刻。\n\n【諸事運勢詳解】：\n- 事業：大忌異動。目前的職位雖辛苦，但跳槽只會落入更深的坑洞。守成為上。\n- 感情：防範爛桃花與第三者，莫因一時寂寞而毀了長久緣分。此時不宜告白。\n- 財運：財星暗淡，小心詐騙。任何關於「快錢」的資訊都是陷阱。\n- 健康：心火過旺，易有失眠或焦慮之症。多接觸大自然與靜坐。\n\n【慈愛勉勵】：\n弟子需修「定」功。建議近期閉門謝客，減少無謂社交。可於每日清晨靜坐十分鐘，穩定磁場。若能抄寫經文一段，更能化解劫難。"
  },
  7: { 
    title: "庚午 ‧ 韓文公遇雪", level: "下平", 
    story: "韓愈被貶潮州，路經藍關遇大雪阻路，馬不能前，心中憂憤不堪，感嘆前途多舛。", 
    poem: ["雲開月出正分明", "不須進退問前程", "婚姻皆由天註定", "何必勞勞苦憂驚"],
    analysis: "【大師深度開示】：\n弟子請聽，韓文公遇雪代表的是一種「突如其來的阻礙」與「內心的動搖」。這雪並非要擋您的路，而是要讓您慢下來思考。此籤雖非大吉，但卻是修心的良方。\n\n【詩意逐句解析】：\n1. 「雲開月出正分明」：烏雲終會散去，真相與機會將會清楚浮現，現在只是暫時的黑暗。\n2. 「不須進退問前程」：現在不是猶豫「進」還是「退」的時候，因為時局尚未完全定案。\n3. 「婚姻皆由天註定」：這裡不只指婚姻，泛指世間一切緣分皆有定數。\n4. 「何必勞勞苦憂驚」：過度的驚慌與奔波只會徒增煩惱，靜待雪融才是上策。\n\n【諸事運勢詳解】：\n- 事業：目前的企劃或任務會遇到暫時性的停擺，不要強行推進，那是逆天而行。\n- 感情：若有衝突，冷處理是最好的方法。雙方都需要空間來冷卻情緒。\n- 財運：財富受阻。適合清點現有資產，不宜進行新的投資。守住現金流。\n- 訴訟：程序拖延，短期內難有定論，需準備長久戰。\n\n【慈愛勉勵】：\n「心安即是家」。雪終究會化，路終究會通。趁這段時間多讀書、多思考，提升內在。建議前往武聖廟參拜，求其正氣化解陰霾。"
  },
  9: { 
    title: "壬申 ‧ 蛟龍入海", level: "大吉", 
    story: "蛟龍得水，如虎添翼，翻雲覆雨，展現無比神通，象徵時機成熟，大有可為。", 
    poem: ["平生富貴成祿位", "君家門戶定光輝", "此去前途通大海", "萬事吉祥保如意"],
    analysis: "【大師深度開示】：\n弟子賀喜！此乃「大任將降、飛龍在天」之極佳卦象。蛟龍入海，意味著您過去所累積的才華、人脈與努力，終於遇到了一個能讓您徹底發揮的舞台。\n\n【詩意逐句解析】：\n1. 「平生富貴成祿位」：您命中應有的福氣與地位，即將在近期得到落實。\n2. 「君家門戶定光輝」：不僅是個人，連帶您的家庭、團隊都會因為您的成功而倍感榮耀。\n3. 「此去前途通大海」：您的視野與空間將會極大化，不再受限於小空間、小職位。\n4. 「萬事吉祥保如意」：在積極進取的過程中，亦能保有平安與如意。\n\n【諸事運勢詳解】：\n- 事業：現在是創業、跳槽、承接重大計畫的黃金期。莫要猶豫，大膽爭取。\n- 感情：這是一首「天作之合」的籤。單身者將遇真命天子/女；有伴者婚姻美滿。\n- 財運：財星高照！偏財運亦佳，但請記住「取之有道」，方能長久。\n- 健康：精力充沛，神采奕奕。但需預防過度透支體力。\n\n【慈愛勉勵】：\n「得意時莫忘本」。龍雖入海，仍需順應潮汐。成功時多提拔後輩，廣結善緣，這份福報才能綿延不絕。建議前往大廟酬神。"
  },
  60: { 
    title: "癸亥 ‧ 薛剛大鬧花燈", level: "下下", 
    story: "薛剛性情魯莽，在元宵花燈會上因酒醉鬧事，誤殺皇子，導致薛家滿門抄斬，慘不忍睹。", 
    poem: ["於今此景正當時", "看看欲晚日遲遲", "勸君把定心莫虛", "天意自有好時節"], 
    analysis: "【大師深度開示】：\n弟子慎之！此為六十甲子籤之終結，亦是「否極泰來」前的最後考驗。薛剛大鬧花燈告誡我們：禍從口出，難從激憤。您目前的處境極其敏感，一丁點的情緒失控都可能引發崩潰。\n\n【詩意逐句解析】：\n1. 「於今此景正當時」：現在正是關鍵的轉折點，也是最容易出錯的時候。\n2. 「看看欲晚日遲遲」：事情已經到了最後關頭，但阻礙依然不斷，令人心焦。\n3. 「勸君把定心莫虛」：這是救命稻草！不論外界如何挑釁，內心必須冷靜如冰。\n4. 「天意自有好時節」：只要撐過這段晦暗，下一個甲子的循環就是光明。\n\n【諸事運勢詳解】：\n- 事業：慎防口舌是非。在職場上多聽少說，莫要參與任何派系鬥爭。忍為上策。\n- 感情：爭吵頻繁。切莫在情緒激動時做出分手或離婚的決定。等冷靜後再談。\n- 財運：財富流失嚴重。避開博弈與酒肉朋友。守住現有資產就是賺錢。\n- 健康：注意意外撞傷或刀火燙傷。遠離聲色場所，避免夜歸。\n\n【慈愛勉勵】：\n戒酒與斷捨離。近期應盡量素食、禁酒，讓大腦保持清醒。可往地藏王菩薩處祈請消災，化解冤親債主之擾。"
  }
};

/**
 * 模擬「大師參悟」的異步邏輯，確保每個籤詩都有專業解析
 */
export const fetchFortunePoem = async (question: string): Promise<FortunePoem> => {
  // 增加思考延遲，營造更深沉的儀式感
  await new Promise(resolve => setTimeout(resolve, 3500));
  
  // 邏輯優化：確保抽出的籤具備深度數據
  const availableSticks = Object.keys(MASTER_DB).map(Number);
  const stickNumber = availableSticks[Math.floor(Math.random() * availableSticks.length)];
  const metadata = MASTER_DB[stickNumber];

  return {
    stickNumber,
    title: metadata.title,
    story: metadata.story,
    poem: metadata.poem,
    meaning: `此籤為「${metadata.level}」。`,
    advice: `【大師深度開示】：\n信眾請聽，關於您所求問的「${question}」一事，大師已將聖意解開。此卦象徵${metadata.level}，個中奧妙非三言兩語能道盡。\n\n${metadata.analysis}\n\n【大師叮嚀】：\n「心誠則靈，運隨心轉」。籤詩是天意的一面鏡子，反映的是當下的因緣。若解析令您心生警惕，那是神明在救您；若解析令您歡喜，那是神明在勉勵您。願弟子秉持正念，福祿自隨。`
  };
};
